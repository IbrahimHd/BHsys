!function(){"use strict";function receiptService($filter,formulas,debugMode){var debugThis=!1,selft=this;selft.calcReceiptTotals=function(receipt){var sum=0;return angular.forEach(receipt.ReceiptItems,function(receiptItem){receipt.ReceiptItems[receipt.ReceiptItems.indexOf(receiptItem)].total=$filter("number")(eval(formulas.receiptItemTotalCost)),sum+=eval(formulas.receiptItemTotalCost)}),receipt.total=$filter("number")(sum),receipt}}angular.module("app").service("receiptService",receiptService),receiptService.$inject=["$filter","formulas","debugMode"]}(),function(){"use strict";function e(e,i,o,n,r,c,a,s,l,p,d,u){var m="/api/receipt/";function f(){e.receipt={receiptId:null,receiptDate:moment().toDate(),supplierId:null,ReceiptItems:[]},e.mode="add"}function g(){e.isSearchSupplierOpen=!("edit"==e.mode)}function I(t){console.log(t),angular.isDefined(t)&&null!==t&&(e.supplier=t,e.receipt.supplierId=t.supplierId,e.receipt.supplierName=t.supplierName,e.receipt.ReceiptItems=[],e.isSearchSupplierOpen=!1)}function h(e){var t=angular.copy(e);return t.itemCost=null,t.itemQnty=null,t.itemPackageCount=null,t.createdAt=null,t.createdBy=null,t.modifiedAt=null,t.modifiedBy=null,t.changed=!1,t.$id=void 0,t.itemCategory=void 0,t.ReceiptItems=void 0,t.supplierId=void 0,t.PackageType=void 0,t}function v(e){var t=[];return angular.forEach(e,function(e,i){t.push(h(e))}),t}function S(t){angular.isDefined(t)&&null!==t&&s.get("/api/item/itemsOfSupplier?splrId="+t).then(function(t){e.items=t.data,console.log(e.items),e.itemsPerparedForReceipt=v(e.items),console.log(e.itemsPerparedForReceipt)}).catch(function(t){e.items=[],e.itemsPerparedForReceipt=[]})}e.isSideItemsMenuOpen=!1,e.isReceiptItemsCollapse=!1,e.isSearchSupplierOpen=!0,e.setReceiptSupplierInfo=I,e.loadMostCommomItemsBySelectedSupplier=S,e.saveReceipt=function(t){console.log("beforeDoingAnything: ",t);var o=i.currentUser.UserLogin;return"edit"===e.mode?(t.modifiedBy=o,angular.forEach(t.ReceiptItems,function(e){e.receiptId=t.receiptId,null===e.createdBy&&(e.createdBy=o),!0===e.changed&&(e.modifiedAt=moment().toDate(),e.modifiedBy=o)}),console.log("put: ",t),s.put(m,t).then(function(e){r.go("layout.receipts")}).catch(function(e){console.log(e)})):(t.createdBy=o,angular.forEach(t.ReceiptItems,function(e){e.receiptId=t.receiptId,e.createdBy=o}),s.post(m,t).then(function(e){f(),g()},function(e){}))},e.msgConfirmCancel=l.msgConfirmCancel,e.msgConfirmRemove=l.msgConfirmRemove,e.msgConfirmDelete=l.msgConfirmDelete,e.isAuthorized="registrar"!=i.currentUser.UserRole||!i.isAuthorized(i.currentUser.UserLogin),e.receipt={},e.isFocused=!1,e.dragControlListeners={accept:function(t,i,n){if(angular.isDefined(t.itemScope.item)){e.isFocused=!0;var r=o("filter")(e.receipt.ReceiptItems,function(e){return e.itemId===t.itemScope.item.itemId})[0];return angular.isDefined(r)?e.itemAlreadyExist={status:!0,item:r}:e.itemAlreadyExist={status:!1,item:null},!angular.isDefined(r)}return!0}},e.isShortActionDone=!1,e.onHoldShortStart=function(t,i,o){i.then(function(t){e.isShortActionDone=!0},function(t){e.selectedItemId=null,e.isShortActionDone=!1,e.holdShortStyle={"background-image":"inherit"}},function(t){e.selectedItemId=o,t>.34&&(e.holdShortStyle={"background-image":"linear-gradient(to top, #3f8 "+100*t+"%, transparent "+100*t+"%)"})})},"undefined"==c.receiptId||null==c.receiptId?f():(e.mode=c.mode,s.get(m+"?receiptId="+c.receiptId,!1).then(function(t){e.receipt=p.calcReceiptTotals(t.data),S(e.receipt.supplierId)})),g(),e.searchText=null,e.noCache=!1,e.querySearch=function(e){return d.searchByName(e)},s.get("/api/common/packageTypes",!1).then(function(t){e.packageTypes=t.data},function(e){}),e.supplierData=function(){return angular.isDefined(e.supplier)?e.supplier:e.receipt.supplierId},e.searchItemsInput="",e.searchingItems=!1,e.searchItems=function(t){if(t.length>0)return e.searchingItems=!0,s.get("/api/item/findItem?strName="+t).then(function(t){e.items=t.data,e.itemsPerparedForReceipt=v(e.items),e.searchingItems=!1}).catch(function(t){e.items=[],e.itemsPerparedForReceipt=[],e.searchItemsNotFound=!0,e.searchingItems=!1})},e.isSideItemsMenuOpen=!0,e.isItemJustAdded=function(e){return!(null===e)},e.restoreReceiptItem=function(t){s.put("/api/receiptItem/remove_restore/?receiptItem_rId="+t.receiptId+"&receiptItem_iId="+t.itemId+"&isDeleted="+!1).then(function(i){e.receipt.ReceiptItems.push(t)},function(e){console.log(e)})},e.removeReceiptItem=function(t){s.put("/api/receiptItem/remove_restore/?receiptItem_rId="+t.receiptId+"&receiptItem_iId="+t.itemId).then(function(i){var o=e.receipt.ReceiptItems.indexOf(t);e.receipt.ReceiptItems.splice(o,1)},function(e){console.log(e)})},e.deleteReceiptItem=function(t){s.delete("/api/receiptItem/?receiptItem_rId="+t.receiptId+"&receiptItem_iId="+t.itemId).then(function(i){var o=e.receipt.ReceiptItems.indexOf(t);e.receipt.ReceiptItems.splice(o,1)},function(e){console.log(e)})},e.openModalItem=function(i,r,c){var s=o("filter")(e.items,function(e){return e.itemId===r})[0],l=angular.copy(s);a.load(["ngMessages","ngFileUpload","ngImgCrop","webcam","imgHandler","scripts/app/webcam.service.js"]).then(function(){n.open({templateUrl:"item/_itemModal.html",animation:!0,size:c,controller:t,controllerAs:"ctrl",resolve:{modalMode:function(){return i},itemToEdit:function(){return l}}}).result.then(function(t){if(console.info("built-in Dialog call back[success]",t.obj,t.action),"addMode"===i){e.items.push(t.obj);var o=angular.copy(t.obj);o.updateImg=!0,e.itemsPerparedForReceipt.push(h(o))}if("editMode"===i){console.log("modal_obj returned: ",t.obj);var n=e.items.map(function(e){return e.itemId}).indexOf(t.obj.itemId);e.items.splice(n,1),e.itemsPerparedForReceipt.splice(n,1),"update"===t.action&&(e.items.push(t.obj),e.itemsPerparedForReceipt.push(h(t.obj)))}},function(e){console.log("modal-component dismissed at: "+new Date,e)})})},e.isOpenReceiptDate=!1,e.xeditableReceiptDateOnShow=function(t){e.isOpenReceiptDate=t},e.updateTotal=function(){e.receipt=p.calcReceiptTotals(e.receipt)},e.supplierOpenModal=function(t,i,o){a.load("supplierDir/supplierModalCtrl.js").then(function(){n.open({templateUrl:"supplierDir/supplierModal.html",animation:!0,size:o,controller:"supplierModalCtrl",resolve:{modalMode:function(){return t},supplierToEdit:function(){return i}}}).result.then(function(i){if(console.info("built-in Dialog call back[success]",i.obj,i.action),"add"===t&&I(i.obj),"edit"===t){console.log("modal_obj returned: ",i.obj);var o=e.items.map(function(e){return e.itemId}).indexOf(i.obj.itemId);e.items.splice(o,1),e.itemsPerparedForReceipt.splice(o,1),"update"===i.action&&(e.receipt.supplierName=i.obj.supplierName)}},function(e){console.log("modal-component dismissed at: "+new Date,e)})})}}function t(e,t,i,o,n,r,c,a){var s=this,l=t.currentUser.UserLogin;function p(e,t){!0===e&&(console.log("ssssssssave img",e,t),s.imgHandlerApi.uploadImg({url:"/api/file?subDirectory=items",imgName:t+".png"}))}s.msgConfirmCancel=c.msgConfirmCancel,s.msgConfirmRemove=c.msgConfirmRemove,s.msgConfirmDelete=c.msgConfirmDelete,s.modalMode=i,"editMode"===s.modalMode?s.itemSelected=o:s.itemSelected={},s.itemSelected.imgIsChanged=!1,s.imgHandlerApi=null,s.closeModal=function(e){n.close(e)},s.cancelModal=function(e){n.dismiss(e)},s.addItem=function(e){e.createdBy=l,r.post("/api/item/",e,"إسم الصنف موجود سابقاً").then(function(t){s.closeModal({obj:t.data,action:"add"}),p(e.imgIsChanged,t.data.itemId)},function(e){a&&console.log(e,"Error, recieptCtrl/addItem/Post.")})},s.saveItem=function(e){e.modifiedBy=l,r.put("/api/item/",e).then(function(e){console.log(e),s.closeModal({obj:e.data,action:"update"})},function(e){a&&console.log(e)}),p(e.imgIsChanged,e.itemId)},s.restoreItem=function(e){r.put("/api/item/remove_restore?itemId="+e.itemId+"&isDeleted="+!1).then(function(e){s.closeModal({obj:e.data,action:"add"})},function(e){a&&console.log(e)})},s.removeItem=function(e){r.put("/api/item/remove_restore?itemId="+e.itemId).then(function(){s.closeModal({obj:e,action:"remove"})},function(e){a&&console.log(e)})},s.deleteItem=function(e){r.delete("/api/item/?itemIdToDelete="+e.itemId).then(function(){s.closeModal({obj:e,action:"remove"})},function(e){a&&console.log(e)})}}angular.module("app").controller("receiptCtrl",e),e.$inject=["$scope","$rootScope","$filter","$uibModal","$state","$stateParams","$ocLazyLoad","dataService","msgConfirm","receiptService","supplierService","debugMode"],t.$inject=["$scope","$rootScope","modalMode","itemToEdit","$uibModalInstance","dataService","msgConfirm","debugMode"]}(),function(){"use strict";function e(e,t,i,o,n,r,c){if("undefined"==i.dataLoad||null==i.dataLoad)console(">>> no data sent via $stateParams");else if(angular.isObject(i.dataLoad))e.receipt=i.dataLoad;else if(angular.isNumber(i.dataLoad)){var a=i.dataLoad;o.get("/api/receipt/?receiptId="+a,!1).then(function(t){e.receipt=n.calcReceiptTotals(t.data)})}e.companyInfo=t.companyInfo,e.goBackState=function(){r.goBack()}}angular.module("app").controller("receiptPrintCtrl",e),e.$inject=["$scope","$rootScope","$stateParams","dataService","receiptService","utilityService","debugMode"]}();