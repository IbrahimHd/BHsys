!function(){"use strict";function e(e,t,r,o){var n=!1;if(r.sessionStorage.userInfo)var s=JSON.parse(r.sessionStorage.userInfo);var i={};r.sessionStorage.getItem("sessionAuth")&&(i=JSON.parse(r.sessionStorage.getItem("sessionAuth")));var a={salt:"rz8LuOtFBXphj9WQfvFh",username:s?s.UserLogin:"",key:i.key||null,ip:i.ip||null,generate:function(s,u){s&&u&&(o&&n&&console.log("SecurityManager: username/password provided>",s,u),a.clear()),a.username=a.username||s,o&&n&&console.log("SecurityManager.username:",a.username),o&&n&&console.log("existing key:",a.key),a.key=a.key||CryptoJS.enc.Base64.stringify(CryptoJS.HmacSHA256([u,a.salt].join(":"),a.salt)),o&&n&&console.log("created key: ",a.key);var c=t.defer();if(a.ip){o&&n&&console.warn('"IP addr", it is already stored');var l=g(a.ip);c.resolve(l)}else o&&n&&console.warn('"IP addr", NOT stored'),e.get("api/Ip/GetIp").then(function(e){var t=g(e.data);return c.resolve(t)},function(e){return console.log(">> IP cannot be gotten << ",e),c.reject(">>Promise: IP cannot be gotten << ")});return c.promise;function g(e){a.ip=e,o&&n&&console.log("SecurityManager.ip: "+a.ip),o&&n&&console.log("username inside getToken: "+a.username),a.username&&(i.key=a.key,i.ip=a.ip,r.sessionStorage.setItem("sessionAuth",JSON.stringify(i)));var t=1e4*(new Date).getTime()+621355968e9;o&&n&&console.log("Client ticks: "+t);var s=[a.username,a.ip,navigator.userAgent.replace(/ \.NET.+;/,""),t].join(":");o&&n&&console.log("Token message>",s);var u=CryptoJS.HmacSHA256(s,a.key),c=CryptoJS.enc.Base64.stringify(u),l=[a.username,t].join(":"),g=CryptoJS.enc.Utf8.parse([c,l].join(":"));return o&&n&&console.log("Client token: "+CryptoJS.enc.Base64.stringify(g)),CryptoJS.enc.Base64.stringify(g)}},clear:function(){a.username=null,a.key=null,a.ip=null}};return a}angular.module("app").factory("securityManager",e),e.$inject=["$http","$q","$window","debugMode"]}(),function(){"use strict";function e(e,t,r,o,n,s,i){var a={};function u(){r.sessionStorage.removeItem("sessionAuth"),r.sessionStorage.removeItem("userInfo"),t.currentUser=void 0,o.clear()}return a.login=function(e,o,i){if(!a.isAuthenticated()){var c={successMsg:"تم تعديل بيانات المستخدم بنجاح.",errorMsg:"حصل خطأ في تعديل بيانات المستخدم."};t.currentUser={},t.currentUser.UserLogin=e.userLogin,t.currentUser.UserPassword=e.password,console.log(t.currentUser),s.get("api/Home/GetUserAccount?user="+e.userLogin,!0,"إسم المستخدم أو كلمة المرور غير صحيحة!").then(function(i){t.currentUser=i.data,t.currentUser.UserPassword=e.password,r.sessionStorage.userInfo=JSON.stringify(t.currentUser),s.put("api/Home/PutLogin?userLogin="+t.currentUser.UserLogin+"&dateTime="+t.now,null,c),o(t.currentUser),n.pop({type:"success",title:"تم الدخول بنجاح",body:"Welcome "+t.currentUser.UserName+"!",toasterId:2}),n.clear(1,null)},function(e){i(e),u()})}},a.isAuthenticated=function(){var e=r.sessionStorage.userInfo?JSON.parse(r.sessionStorage.userInfo):null;return!!e&&!!e.UserRole},a.isAuthorized=function(e){angular.isArray(e)||(e=[e]);var t=r.sessionStorage.userInfo?JSON.parse(r.sessionStorage.userInfo):null;return a.isAuthenticated()&&-1!==e.indexOf(t.UserRole)},a.logout=function(e){s.put("api/Home/PutLogOut?userLogin="+e+"&dateTime="+t.now),u()},a}angular.module("app").factory("authService",e),e.$inject=["$http","$rootScope","$window","securityManager","toaster","dataService","debugMode"]}(),function(){"use strict";function e(e,t,r){var o=!0;this.notify=function(){return arguments.length>0&&console.log("autNotify:",arguments.length,arguments[0]),{notAuthenticated:function(){r&&o&&console.warn("=============> notAuthenticated, redirect to Login."),t.warning({title:"Not Authenticated",body:"Sorry, you have to log in first.",size:"sm",toasterId:2})},notAuthorized:function(){r&&o&&console.warn(">>>===== NOT Authorized"),t.error({title:"Not Authorized",body:"Sorry, the user account you logged in with is not authorized to see that information. Log in with a different user account or contact the focal point of the system.",size:"sm",toasterId:2})}}}}angular.module("app").service("authNotifyService",e),e.$inject=["$rootScope","toaster","debugMode"]}(),function(){"use strict";angular.module("app").run(["$transitions","$trace",function(e,t){e.onError({},e=>{console.warn('WARNING: ui-router transition "onError" has been invoked.',"file: routerSecurity.js")})}]).run(["$transitions","$rootScope","$location","authService","authNotifyService","toaster","debugMode",function(e,t,r,o,n,s,i){function a(e){return""===e.from().name&&e.router.stateService.target("layout.landing",null,{reload:!0})}e.onStart({},function(e){t.isUserAuthenticated=!1,t.isUserAuthorized=!1,t.redirectPath=r.path(),t.redirectSearchQuery=r.search();let i=e.to();e.params();var u=i.access.authorizedRoles;if(t.authorizedRoles=u,"login"===i.name&&o.isAuthenticated())return s.pop({type:"info",title:"تم الدخول سابقاً",body:"لقد تم الدخول سابقاً. إن كنت تريد الدخول بإسم مستخدم آخر, قم بالخروج ثم قم بالدخول بإسم المستخدم الذي تريد.",toasterId:2}),a(e);if(angular.isUndefined(i.access))console.warn("WARNING: authorization is not set on this state: ",i.name);else{if(!o.isAuthenticated())return n.notify().notAuthenticated(),e.router.stateService.target("login",null,{reload:!0});if(t.isUserAuthenticated=!0,!o.isAuthorized(u))return n.notify("customized notification message goes here!"),n.notify().notAuthorized(),a(e);t.isUserAuthorized=!0,console.warn("OK =============> Authorized")}})}])}(),function(){"use strict";function e(e,t,r){return{responseError:function(o){return e.$broadcast({401:r.notAuthenticated,403:r.notAuthorized,419:r.sessionTimeout,440:r.sessionTimeout}[o.status],o),t.reject(o)}}}angular.module("app").factory("AuthInterceptor",e),e.$inject=["$rootScope","$q","AUTH_EVENTS"]}();