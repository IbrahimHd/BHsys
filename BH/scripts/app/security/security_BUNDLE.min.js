!function(){"use strict";function e(e,t,o,r){var n=!1;if(o.sessionStorage.userInfo)var s=JSON.parse(o.sessionStorage.userInfo);var i={};o.sessionStorage.getItem("sessionAuth")&&(i=JSON.parse(o.sessionStorage.getItem("sessionAuth")));var a={salt:"rz8LuOtFBXphj9WQfvFh",username:s?s.UserLogin:"",key:i.key||null,ip:i.ip||null,generate:function(s,u){s&&u&&(r&&n&&console.log("SecurityManager: username/password provided>",s,u),a.clear()),a.username=a.username||s,r&&n&&console.log("SecurityManager.username:",a.username),r&&n&&console.log("existing key:",a.key),a.key=a.key||CryptoJS.enc.Base64.stringify(CryptoJS.HmacSHA256([u,a.salt].join(":"),a.salt)),r&&n&&console.log("created key: ",a.key);var c=t.defer();if(a.ip){r&&n&&console.warn('"IP addr", it is already stored');var l=g(a.ip);c.resolve(l)}else r&&n&&console.warn('"IP addr", NOT stored'),e.get("api/Ip/GetIp").then(function(e){var t=g(e.data);return c.resolve(t)},function(e){return console.log(">> IP cannot be gotten << ",e),c.reject(">>Promise: IP cannot be gotten << ")});return c.promise;function g(e){a.ip=e,r&&n&&console.log("SecurityManager.ip: "+a.ip),r&&n&&console.log("username inside getToken: "+a.username),a.username&&(i.key=a.key,i.ip=a.ip,o.sessionStorage.setItem("sessionAuth",JSON.stringify(i)));var t=1e4*(new Date).getTime()+621355968e9;r&&n&&console.log("Client ticks: "+t);var s=[a.username,a.ip,navigator.userAgent.replace(/ \.NET.+;/,""),t].join(":");r&&n&&console.log("Token message>",s);var u=CryptoJS.HmacSHA256(s,a.key),c=CryptoJS.enc.Base64.stringify(u),l=[a.username,t].join(":"),g=CryptoJS.enc.Utf8.parse([c,l].join(":"));return r&&n&&console.log("Client token: "+CryptoJS.enc.Base64.stringify(g)),CryptoJS.enc.Base64.stringify(g)}},clear:function(){a.username=null,a.key=null,a.ip=null}};return a}angular.module("app").factory("securityManager",e),e.$inject=["$http","$q","$window","debugMode"]}(),function(){"use strict";function e(e,t,o,r,n,s,i){var a={};function u(){o.sessionStorage.removeItem("sessionAuth"),o.sessionStorage.removeItem("userInfo"),t.currentUser=void 0,r.clear()}return a.login=function(e,r,i){if(!a.isAuthenticated()){var c={successMsg:"تم تعديل بيانات المستخدم بنجاح.",errorMsg:"حصل خطأ في تعديل بيانات المستخدم."};t.currentUser={},t.currentUser.UserLogin=e.userLogin,t.currentUser.UserPassword=e.password,console.log(t.currentUser),s.get("api/Home/GetUserAccount?user="+e.userLogin,!0,"إسم المستخدم أو كلمة المرور غير صحيحة!").then(function(i){t.currentUser=i.data,t.currentUser.UserPassword=e.password,o.sessionStorage.userInfo=JSON.stringify(t.currentUser),s.put("api/Home/PutLogin?userLogin="+t.currentUser.UserLogin+"&dateTime="+t.now,null,c),r(t.currentUser),n.pop({type:"success",title:"تم الدخول بنجاح",body:"Welcome "+t.currentUser.UserName+"!",toasterId:2}),n.clear(1,null)},function(e){i(e),u()})}},a.isAuthenticated=function(){var e=o.sessionStorage.userInfo?JSON.parse(o.sessionStorage.userInfo):null;return!!e&&!!e.UserRole},a.isAuthorized=function(e){angular.isArray(e)||(e=[e]);var t=o.sessionStorage.userInfo?JSON.parse(o.sessionStorage.userInfo):null;return a.isAuthenticated()&&-1!==e.indexOf(t.UserRole)},a.logout=function(e){s.put("api/Home/PutLogOut?userLogin="+e+"&dateTime="+t.now),u()},a}angular.module("app").factory("authService",e),e.$inject=["$http","$rootScope","$window","securityManager","toaster","dataService","debugMode"]}(),function(){"use strict";function e(e,t,o){var r=!0;this.notify=function(){return arguments.length>0&&console.log("autNotify:",arguments.length,arguments[0]),{notAuthenticated:function(){o&&r&&console.warn("=============> notAuthenticated, redirect to Login."),t.warning({title:"Not Authenticated",body:"Sorry, you have to log in first.",size:"sm",toasterId:2})},notAuthorized:function(){o&&r&&console.warn(">>>===== NOT Authorized"),t.error({title:"Not Authorized",body:"Sorry, the user account you logged in with is not authorized to see that information. Log in with a different user account or contact the focal point of the system.",size:"sm",toasterId:2})}}}}angular.module("app").service("authNotifyService",e),e.$inject=["$rootScope","toaster","debugMode"]}(),function(){"use strict";angular.module("app").run(["$transitions","$trace",function(e,t){e.onError({},e=>{console.warn('WARNING: ui-router transition "onError" has been invoked.',"file: routerSecurity.js")})}]).run(["$transitions","$rootScope","$location","authService","authNotifyService","toaster","debugMode",function(e,t,o,r,n,s,i){function a(e){return""===e.from().name&&e.router.stateService.target("layout.landing",null,{reload:!0})}e.onStart({},function(e){t.redirectPath=o.path(),t.redirectSearchQuery=o.search();let u=e.to();e.params();if(console.log(u.name,"authService.isAuthenticated() ",r.isAuthenticated()),"login"===u.name&&r.isAuthenticated())return i&&console.log("ALREADY LOGGED IN!"),s.pop({type:"info",title:"تم الدخول سابقاً",body:"لقد تم الدخول سابقاً. إن كنت تريد الدخول بإسم مستخدم آخر, قم بالخروج ثم قم بالدخول بإسم المستخدم الذي تريد.",toasterId:2}),a(e);if(angular.isUndefined(u.access))console.warn("WARNING: authorization is not set on this state: ",u.name);else{if(!r.isAuthenticated())return n.notify().notAuthenticated(),e.router.stateService.target("login",null,{reload:!0});var c=u.access.authorizedRoles;if(t.authorizedRoles=c,console.log("authService.isAuthorized(authorizedRoles)",r.isAuthorized(c)),!r.isAuthorized(c))return n.notify("customized notification message goes here!"),n.notify().notAuthorized(),a(e);console.warn("OK =============> Authorized")}})}])}(),function(){"use strict";function e(e,t,o){return{responseError:function(r){return e.$broadcast({401:o.notAuthenticated,403:o.notAuthorized,419:o.sessionTimeout,440:o.sessionTimeout}[r.status],r),t.reject(r)}}}angular.module("app").factory("AuthInterceptor",e),e.$inject=["$rootScope","$q","AUTH_EVENTS"]}();